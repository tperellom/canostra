<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Llista d'Idees per Ca Nostra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Llibreria per arrossegar i reordenar -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .list-item:hover .action-buttons { opacity: 1; }
        .action-buttons { opacity: 0; transition: opacity 0.2s ease-in-out; }
        .tag { background-color: #e0e7ff; color: #4338ca; }
        #confirmation-modal { transition: opacity 0.3s ease; }
        
        .sortable-ghost {
            background-color: #e0e7ff;
            opacity: 0.5;
        }
        .list-item {
            cursor: grab;
        }
        .tag-filter.active {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
        /* Per defecte, amaguem els formularis d'afegir i els botons d'acció de cada idea */
        .add-form-container,
        .list-item .action-buttons {
            display: none;
        }

        /* Quan la targeta té la classe .is-editing, mostrem els elements ocults */
        .room-section.is-editing .add-form-container {
            display: block;
        }
        .room-section.is-editing .list-item .action-buttons {
            display: flex; /* O 'block' si prefereixes */
            opacity: 1;
        }

        /* Canviem el cursor per indicar si es pot arrossegar o no */
        .list-item {
            cursor: default; /* El cursor normal quan no s'està editant */
        }
        .room-section.is-editing .list-item {
            cursor: grab; /* El cursor de "mà" per arrossegar quan s'està editant */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Pantalla de Login -->
    <div id="login-container" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Iniciar Sessió</h2>
            <div class="space-y-4">
                <input type="email" id="email" placeholder="Correu electrònic" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" id="password" placeholder="Contrasenya" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="login()" class="w-full bg-blue-600 text-white font-semibold p-3 rounded-lg hover:bg-blue-700 transition">Entrar</button>
                <p id="login-error" class="text-red-500 text-sm text-center"></p>
            </div>
        </div>
    </div>

    <!-- Contingut Principal de l'App (Ocult per defecte) -->
    <div id="app-container" class="hidden container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
        <header class="mb-10">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Idees per a la Casa</h1>
                <div class="text-right">
                    <p id="user-email" class="text-sm text-gray-600"></p>
                    <button onclick="logout()" class="text-sm text-blue-600 hover:underline">Tancar sessió</button>
                </div>
            </div>
            <!-- Contenidor per als botons de filtre per etiqueta -->
            <div id="tags-filter-container" class="mt-6 flex flex-wrap gap-2 border-b border-gray-200 pb-4">
                <!-- Els botons de les etiquetes es generaran aquí -->
            </div>
        </header>

        <div class="mb-8 bg-white p-4 rounded-xl shadow-md">
            <div class="flex flex-col sm:flex-row gap-4">
                <input type="text" id="new-room-name" placeholder="Nom de la nova habitació" class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="addRoom()" class="bg-blue-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2">
                    <i class="ph-bold ph-plus-circle text-xl"></i><span>Afegir Habitació</span>
                </button>
            </div>
        </div>

        <main id="rooms-container" class="space-y-8"></main>
        <div id="loading-message" class="text-center text-gray-500 mt-10">Carregant dades...</div>
    </div>

    <!-- Modal de Confirmació d'Esborrat -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 id="modal-title" class="text-lg font-bold text-gray-900">Confirmar acció</h3>
            <p id="modal-message" class="mt-2 text-sm text-gray-600">Estàs segur que vols continuar?</p>
            <div class="mt-6 flex justify-end gap-4">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel·lar</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Esborrar</button>
            </div>
        </div>
    </div>

    <script type="module">
        const firebaseConfig = {
          apiKey: "AIzaSyDjMJi26sdZIOt1c9b7JOl1i7XuFdT5kpw",
          authDomain: "canostra-cb0bc.firebaseapp.com",
          projectId: "canostra-cb0bc",
          storageBucket: "canostra-cb0bc.firebasestorage.app",
          messagingSenderId: "374627600235",
          appId: "1:374627600235:web:ec9d5da589a03d85a56e2e",
          measurementId: "G-PSDDZ36JNQ"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, updateDoc, query, orderBy, getDocs, getDoc, writeBatch, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const roomsContainer = document.getElementById('rooms-container');
        const loadingMessage = document.getElementById('loading-message');
        const tagsFilterContainer = document.getElementById('tags-filter-container');
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');

        let unsubscribeFromRooms = null; 
        let activeFilters = new Set();

        // --- Gestió d'Autenticació ---
        onAuthStateChanged(auth, user => {
            if (user) {
                loginContainer.style.display = 'none';
                appContainer.style.display = 'block';
                document.getElementById('user-email').textContent = user.email;
                loadData();
            } else {
                loginContainer.style.display = 'flex';
                appContainer.style.display = 'none';
                if (unsubscribeFromRooms) {
                    unsubscribeFromRooms();
                    unsubscribeFromRooms = null;
                }
            }
        });

        window.login = () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorP = document.getElementById('login-error');
            errorP.textContent = '';
            signInWithEmailAndPassword(auth, email, password)
                .catch(error => {
                    errorP.textContent = 'Error: Correu o contrasenya incorrectes.';
                });
        };

        window.logout = () => signOut(auth);

        // --- Càrrega i Renderitzat de Dades ---
        function loadData() {
            if (unsubscribeFromRooms) {
                unsubscribeFromRooms();
            }

            unsubscribeFromRooms = onSnapshot(query(collection(db, "rooms"), orderBy("createdAt", "asc")), async (snapshot) => {
                const roomsData = [];
                const promises = snapshot.docs.map(async (roomDoc) => {
                    const room = { id: roomDoc.id, ...roomDoc.data(), ideas: [] };
                    const ideasQuery = query(collection(db, `rooms/${room.id}/ideas`));
                    
                    const ideasSnapshot = await getDocs(ideasQuery);
                    room.ideas = ideasSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    roomsData.push(room);
                });

                await Promise.all(promises);
                roomsData.sort((a, b) => a.createdAt.toMillis() - b.createdAt.toMillis());
                
                const allTags = [...new Set(roomsData.flatMap(room => room.tags || []))].sort();
                renderTagFilters(allTags);
                
                renderRooms(roomsData);
                applyFilters(); // Aplica els filtres actius després de renderitzar
            });
        }

        function renderRooms(rooms) {
            roomsContainer.innerHTML = '';
            loadingMessage.style.display = rooms.length === 0 ? 'block' : 'none';
            if (rooms.length === 0) loadingMessage.textContent = 'No hi ha cap habitació. Afegeix-ne una per començar!';

            rooms.forEach(room => {
                const roomElement = document.createElement('section');
                roomElement.className = 'room-section bg-white rounded-xl shadow-lg p-6 sm:p-8';
                roomElement.dataset.roomTags = (room.tags || []).join(',');
                roomElement.dataset.roomId = room.id; // <-- AFEGIM AQUEST ATRIBUT IMPORTANT

                const necessitats = room.ideas.filter(i => i.section === 'necessitat').sort((a, b) => a.order - b.order);
                const tasquesPendents = room.ideas.filter(i => i.section === 'tasca-pendent').sort((a, b) => a.order - b.order);
                const opcionals = room.ideas.filter(i => i.section === 'opcional').sort((a, b) => a.order - b.order);
                const referencies = room.ideas.filter(i => i.section === 'referencia').sort((a, b) => a.order - b.order);

                roomElement.innerHTML = `
                    <div class="flex justify-between items-center border-b-2 border-gray-100 pb-3 mb-5">
                        <h2 class="text-2xl font-semibold text-gray-800">${room.name}</h2>
                        <div class="flex items-center gap-2">
                            <button onclick="toggleEditMode('${room.id}')" title="Activar edició" class="edit-mode-btn text-blue-600 hover:bg-blue-50 p-2 rounded-full transition">
                                <i class="ph ph-pencil-simple text-2xl"></i>
                            </button>
                            <button onclick="deleteRoom('${room.id}', '${room.name}')" class="text-gray-400 hover:text-red-500 transition p-2 rounded-full"><i class="ph-bold ph-trash text-2xl"></i></button>
                        </div>
                    </div>

                    ${renderSection(room, 'necessitat', 'Necessitat principal', 'Indica les necessitats principals', necessitats, true)}
                    ${renderSection(room, 'tasca-pendent', 'Tasques pendents', 'Nova tasca pendent...', tasquesPendents)}
                    ${renderSection(room, 'opcional', 'Opcionals', 'Nova idea opcional', opcionals)}
                    ${renderSection(room, 'referencia', 'Referències', 'Nova referència', referencies)}
                    
                    <div class="section-container mt-8 border-t border-gray-100 pt-6" id="tags-section-${room.id}">
                        ${renderRoomTags(room)}
                    </div>
                `;
                roomsContainer.appendChild(roomElement);
            });
            
            initializeSortable();
        }
        
        function renderRoomTags(room) {
            const tagsHTML = (room.tags || []).map(tag => `<span class="tag text-sm font-medium mr-2 mb-2 inline-block px-3 py-1 rounded-full">${tag}</span>`).join('');
            return `
                <div class="flex items-center gap-4">
                     <h3 class="text-xl font-medium text-gray-700">Etiquetes</h3>
                     <button onclick="editRoomTags('${room.id}')" class="text-gray-400 hover:text-blue-500 transition p-1 rounded-full"><i class="ph ph-pencil-simple"></i></button>
                </div>
                <div class="mt-2 flex flex-wrap">
                    ${tagsHTML || '<p class="text-sm text-gray-500">No hi ha etiquetes per a aquesta habitació.</p>'}
                </div>
            `;
        }

        function renderSection(room, sectionId, title, placeholder, ideas, isFirst = false) {
            const borderClass = isFirst ? '' : 'border-t border-gray-100';
            const inputFieldsHTML = sectionId === 'referencia'
                ? `
                    <div class="flex flex-col sm:flex-row gap-2">
                        <input type="text" id="new-idea-text-${room.id}-${sectionId}" placeholder="Text de l'enllaç" class="flex-grow p-2 border border-gray-300 rounded-lg">
                        <input type="url" id="new-idea-link-${room.id}-${sectionId}" placeholder="URL de l'enllaç" class="flex-grow p-2 border border-gray-300 rounded-lg">
                    </div>
                    <button onclick="addIdea('${room.id}', '${sectionId}')" class="mt-2 bg-gray-200 text-gray-700 font-semibold px-4 py-2 rounded-lg hover:bg-gray-300 transition">Afegir</button>
                `
                : `
                    <input type="text" id="new-idea-text-${room.id}-${sectionId}" placeholder="${placeholder}" class="w-full p-2 border border-gray-300 rounded-lg">
                    <button onclick="addIdea('${room.id}', '${sectionId}')" class="mt-2 bg-gray-200 text-gray-700 font-semibold px-4 py-2 rounded-lg hover:bg-gray-300 transition">Afegir</button>
                `;

            return `<div class="section-container mt-8 pt-6 ${borderClass}"><h3 class="text-xl font-medium text-gray-700 mb-3">${title}</h3><ul id="idea-list-${room.id}-${sectionId}" class="sortable-list space-y-2 list-disc pl-5" data-room-id="${room.id}" data-section-id="${sectionId}">${ideas.map(idea => renderIdea(idea, room.id)).join('')}</ul><div class="add-form-container mt-4">${inputFieldsHTML}</div></div>`;
        }

        function renderIdea(idea, roomId) {
            const isReference = idea.link && idea.section === 'referencia';
            const content = isReference 
                ? `<a href="${idea.link}" target="_blank" class="text-blue-600 hover:underline break-all">${idea.text}</a>` 
                : `<span class="break-words">${idea.text}</span>`;
            
            return `<li class="list-item" data-id="${idea.id}"><div class="flex items-center justify-between group p-2 rounded-md hover:bg-gray-50"><div class="flex-grow" ondblclick="editIdea(this, '${roomId}', '${idea.id}')">${content}</div><div class="action-buttons flex items-center gap-2 ml-4"><button onclick="editIdea(this.parentElement.previousElementSibling, '${roomId}', '${idea.id}')" class="text-gray-400 hover:text-blue-500 p-1"><i class="ph ph-pencil-simple"></i></button><button onclick="deleteIdea('${roomId}', '${idea.id}')" class="text-gray-400 hover:text-red-500 p-1"><i class="ph ph-trash"></i></button></div></div></li>`;
        }
        
        // --- Lògica de Dades (CRUD) ---
        
        function showConfirmationModal(title, message, onConfirm) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            
            const newConfirmBtn = modalConfirmBtn.cloneNode(true);
            modalConfirmBtn.parentNode.replaceChild(newConfirmBtn, modalConfirmBtn);
            
            newConfirmBtn.onclick = () => {
                onConfirm();
                confirmationModal.classList.add('hidden');
            };
            
            modalCancelBtn.onclick = () => {
                confirmationModal.classList.add('hidden');
            };

            confirmationModal.classList.remove('hidden');
        }

        window.addRoom = async () => {
            const input = document.getElementById('new-room-name');
            if (input.value.trim()) {
                await addDoc(collection(db, "rooms"), { 
                    name: input.value.trim(), 
                    tags: [],
                    createdAt: new Date() 
                });
                input.value = '';
            }
        };

        window.deleteRoom = (roomId, roomName) => {
            showConfirmationModal(
                `Esborrar "${roomName}"`,
                'Segur que vols esborrar aquesta habitació i TOTES les seves idees? Aquesta acció no es pot desfer.',
                async () => {
                    const subcollections = ['ideas'];
                    for (const sc of subcollections) {
                        const snapshot = await getDocs(query(collection(db, `rooms/${roomId}/${sc}`)));
                        await Promise.all(snapshot.docs.map(d => deleteDoc(d.ref)));
                    }
                    await deleteDoc(doc(db, "rooms", roomId));
                }
            );
        };

        window.addIdea = async (roomId, section) => {
            const textInput = document.getElementById(`new-idea-text-${roomId}-${section}`);
            const text = textInput.value.trim();
            
            // Trobem la llista corresponent a la secció per afegir el nou element
            const listElement = document.getElementById(`idea-list-${roomId}-${section}`);
            if (!listElement) {
                console.error("No s'ha trobat la llista on afegir la idea.");
                return;
            }

            // Calculem el nou ordre basant-nos en els elements que ja existeixen a la llista
            const newOrder = listElement.children.length;

            let data = { text, section, order: newOrder, createdAt: new Date() };
            let newDocRef = null; // Guardarem la referència del nou document aquí

            // Lògica per afegir la idea (normal o referència)
            if (section === 'referencia') {
                const linkInput = document.getElementById(`new-idea-link-${roomId}-${section}`);
                const link = linkInput.value.trim();
                if (text && link) {
                    data.link = link;
                    // Desem la idea i guardem la seva referència
                    newDocRef = await addDoc(collection(db, `rooms/${roomId}/ideas`), data);
                    textInput.value = '';
                    linkInput.value = '';
                }
            } else {
                if (text) {
                    // Desem la idea i guardem la seva referència
                    newDocRef = await addDoc(collection(db, `rooms/${roomId}/ideas`), data);
                    textInput.value = '';
                }
            }

            if (newDocRef) {
                // 1. Creem l'objecte de la nova idea amb l'ID obtingut
                const newIdea = { id: newDocRef.id, ...data };
                
                // 2. Usem la funció que ja tenies (renderIdea) per crear l'HTML del nou element <li>
                const ideaHTML = renderIdea(newIdea, roomId);

                // 3. Creem un element temporal per convertir el text HTML a un node del DOM
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = ideaHTML;
                const newIdeaElement = tempDiv.firstChild;
                
                // 4. Finalment, afegim el nou element <li> al final de la llista <ul> correcta
                listElement.appendChild(newIdeaElement);
            }
        };

       window.deleteIdea = (roomId, ideaId) => {
            showConfirmationModal(
                'Esborrar idea',
                'Segur que vols esborrar aquesta idea?',
                async () => {
                    // 1. Esborrem el document de la base de dades
                    await deleteDoc(doc(db, `rooms/${roomId}/ideas`, ideaId));

                    // 2. Trobem l'element <li> corresponent a la pàgina usant el seu 'data-id'
                    const elementToDelete = document.querySelector(`li.list-item[data-id='${ideaId}']`);
                    
                    if (elementToDelete) {
                        const listElement = elementToDelete.parentElement; // Guardem una referència a la llista <ul> pare
                        
                        // 3. Eliminem l'element de la pàgina per a un efecte visual instantani
                        elementToDelete.remove();

                        // 4. (Extra) Actualitzem l'ordre dels elements restants per mantenir la consistència
                        if (listElement) {
                            const batch = writeBatch(db);
                            Array.from(listElement.children).forEach((item, index) => {
                                const id = item.dataset.id;
                                if (id) {
                                    const ideaRef = doc(db, `rooms/${roomId}/ideas`, id);
                                    batch.update(ideaRef, { order: index });
                                }
                            });
                            await batch.commit(); // Enviem tots els canvis d'ordre de cop
                        }
                    }
                }
            );
        };
        
        window.editIdea = async (element, roomId, ideaId) => {

            // Comprovació de seguretat: només s'executa si estem en mode edició
            const roomElement = element.closest('.room-section');
            if (!roomElement || !roomElement.classList.contains('is-editing')) {
                return; // No fa res si no estem en mode edició
            }
            
            const ideaDocRef = doc(db, `rooms/${roomId}/ideas`, ideaId);
            // És més eficient obtenir un sol document amb getDoc que consultar tota la col·lecció
            const ideaSnap = await getDoc(ideaDocRef);

            if (!ideaSnap.exists()) {
                console.error("Error: No s'ha trobat la idea per editar.");
                return;
            }
            const ideaData = ideaSnap.data();

            // Guardem l'HTML original per si l'usuari cancel·la l'edició
            const originalHTML = element.innerHTML;

            let editHTML;
            if (ideaData.section === 'referencia') {
                editHTML = `
                    <div class="p-2 border border-blue-500 rounded-lg bg-white">
                        <input type="text" value="${ideaData.text}" placeholder="Text de l'enllaç" class="w-full p-1 rounded-md mb-2 border border-gray-300">
                        <input type="url" value="${ideaData.link || ''}" placeholder="URL de l'enllaç" class="w-full p-1 rounded-md mb-2 border border-gray-300">
                        <div class="mt-2 flex items-center gap-2">
                            <button class="save-btn bg-blue-600 text-white px-3 py-1 rounded-md text-sm font-semibold hover:bg-blue-700">Desar</button>
                            <button class="cancel-btn text-sm text-gray-600 hover:underline">Cancel·lar</button>
                        </div>
                    </div>`;
            } else {
                editHTML = `
                    <div class="p-2 border border-blue-500 rounded-lg bg-white">
                        <input type="text" value="${ideaData.text}" class="w-full p-1 rounded-md mb-2 border border-gray-300">
                        <div class="mt-2 flex items-center gap-2">
                            <button class="save-btn bg-blue-600 text-white px-3 py-1 rounded-md text-sm font-semibold hover:bg-blue-700">Desar</button>
                            <button class="cancel-btn text-sm text-gray-600 hover:underline">Cancel·lar</button>
                        </div>
                    </div>`;
            }
            element.innerHTML = editHTML;
            element.querySelector('input[type="text"]').focus(); // Millora: posa el focus a l'input

            // Lògica del botó "Desar"
            element.querySelector('.save-btn').onclick = async () => {
                let updateData = {};
                let newContentHTML = '';

                if (ideaData.section === 'referencia') {
                    const newText = element.querySelector('input[type="text"]').value.trim();
                    const newLink = element.querySelector('input[type="url"]').value.trim();
                    if (newText && newLink) {
                        updateData = { text: newText, link: newLink };
                        newContentHTML = `<a href="${newLink}" target="_blank" class="text-blue-600 hover:underline break-all">${newText}</a>`;
                    }
                } else {
                    const newText = element.querySelector('input[type="text"]').value.trim();
                    if (newText) {
                        updateData = { text: newText };
                        newContentHTML = `<span class="break-words">${newText}</span>`;
                    }
                }
                
                if (Object.keys(updateData).length > 0) {
                    await updateDoc(ideaDocRef, updateData);
                    // Actualitza la UI immediatament
                    element.innerHTML = newContentHTML;
                } else {
                    // Si no hi ha dades vàlides (ex: text buit), restaura l'estat original
                    element.innerHTML = originalHTML;
                }
            };

            // Lògica del botó "Cancel·lar"
            element.querySelector('.cancel-btn').onclick = () => {
                // Restaura l'HTML original sense recarregar-ho tot
                element.innerHTML = originalHTML;
            };
        };

        window.editRoomTags = async (roomId) => {
            const tagsSection = document.getElementById(`tags-section-${roomId}`);
            const roomDocRef = doc(db, "rooms", roomId);
            const roomSnapshot = await getDocs(query(collection(db, "rooms"))).then(s => s.docs.find(d => d.id === roomId));
            if (!roomSnapshot) return;
            const currentTags = roomSnapshot.data().tags || [];

            tagsSection.innerHTML = `
                <div class="p-2 border border-blue-500 rounded-lg">
                    <h3 class="text-xl font-medium text-gray-700 mb-2">Editar Etiquetes</h3>
                    <input type="text" value="${currentTags.join(', ')}" placeholder="Etiquetes separades per comes" class="w-full p-2 border border-gray-300 rounded-lg">
                    <div class="mt-2">
                        <button class="save-tags-btn bg-blue-500 text-white px-3 py-1 rounded-md text-sm">Desar</button>
                        <button class="cancel-tags-btn text-sm ml-2">Cancel·lar</button>
                    </div>
                </div>
            `;

            tagsSection.querySelector('.save-tags-btn').onclick = async () => {
                const input = tagsSection.querySelector('input');
                const newTags = input.value.split(',').map(t => t.trim()).filter(Boolean);
                await updateDoc(roomDocRef, { tags: newTags });
            };
            tagsSection.querySelector('.cancel-tags-btn').onclick = () => loadData();
        };

        window.toggleEditMode = (roomId) => {
            const roomElement = document.querySelector(`.room-section[data-room-id='${roomId}']`);
            if (!roomElement) return;

            const editButton = roomElement.querySelector('.edit-mode-btn');
            const isEditing = roomElement.classList.toggle('is-editing');

            if (isEditing) {
                // Canviem a MODE EDICIÓ
                editButton.innerHTML = `<i class="ph-fill ph-check-circle text-2xl text-green-600"></i>`;
                editButton.title = "Finalitzar edició";
            } else {
                // Tornem a MODE VISUALITZACIÓ
                editButton.innerHTML = `<i class="ph ph-pencil-simple text-2xl"></i>`;
                editButton.title = "Activar edició";
            }
        };

        // --- Lògica de Reordenació ---
        function initializeSortable() {
            document.querySelectorAll('.sortable-list').forEach(list => {
                new Sortable(list, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    onEnd: async (evt) => {
                        const listElement = evt.from;
                        const roomId = listElement.dataset.roomId;
                        
                        const batch = writeBatch(db);
                        Array.from(listElement.children).forEach((item, index) => {
                            const ideaId = item.dataset.id;
                            const ideaRef = doc(db, `rooms/${roomId}/ideas`, ideaId);
                            batch.update(ideaRef, { order: index });
                        });
                        await batch.commit();
                    }
                });
            });
        }

        // --- Lògica de Filtre per Etiquetes ---
        function renderTagFilters(tags) {
            tagsFilterContainer.innerHTML = '';
            
            const allButton = document.createElement('button');
            allButton.id = 'all-rooms-btn';
            allButton.className = 'tag-filter px-3 py-1 border border-gray-300 text-gray-800 rounded-full text-sm font-medium';
            allButton.textContent = 'Totes les habitacions';
            allButton.onclick = () => resetFilters();
            tagsFilterContainer.appendChild(allButton);

            tags.forEach(tag => {
                const tagButton = document.createElement('button');
                tagButton.className = 'tag-filter px-3 py-1 border border-gray-300 text-gray-800 rounded-full text-sm font-medium';
                tagButton.textContent = tag;
                tagButton.dataset.tag = tag;
                tagButton.onclick = () => toggleTagFilter(tag, tagButton);
                tagsFilterContainer.appendChild(tagButton);
            });

            updateActiveFilterButtons();
        }
        
        function resetFilters() {
            activeFilters.clear();
            applyFilters();
        }

        function toggleTagFilter(tag, clickedButton) {
            if (activeFilters.has(tag)) {
                activeFilters.delete(tag);
            } else {
                activeFilters.add(tag);
            }
            applyFilters();
        }

        function applyFilters() {
            updateActiveFilterButtons();
            document.querySelectorAll('.room-section').forEach(room => {
                if (activeFilters.size === 0) {
                    room.style.display = 'block';
                    return;
                }

                const roomTags = (room.dataset.roomTags || '').split(',');
                const hasAllTags = [...activeFilters].every(filterTag => roomTags.includes(filterTag));
                
                room.style.display = hasAllTags ? 'block' : 'none';
            });
        }

        function updateActiveFilterButtons() {
            document.querySelectorAll('.tag-filter').forEach(btn => {
                const tag = btn.dataset.tag;
                if (tag && activeFilters.has(tag)) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            const allBtn = document.getElementById('all-rooms-btn');
            if (activeFilters.size === 0) {
                allBtn.classList.add('active');
            } else {
                allBtn.classList.remove('active');
            }
        }
    </script>
</body>
</html>
