<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Llista d'Idees per a la Casa (Dinàmica)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .list-item:hover .action-buttons, .image-item:hover .action-buttons { opacity: 1; }
        .action-buttons { opacity: 0; transition: opacity 0.2s ease-in-out; }
        .tag { background-color: #e0e7ff; color: #4338ca; }
        .highlight { background-color: #fef9c3; }
        #confirmation-modal { transition: opacity 0.3s ease; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Pantalla de Login -->
    <div id="login-container" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Iniciar Sessió</h2>
            <div class="space-y-4">
                <input type="email" id="email" placeholder="Correu electrònic" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" id="password" placeholder="Contrasenya" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="login()" class="w-full bg-blue-600 text-white font-semibold p-3 rounded-lg hover:bg-blue-700 transition">Entrar</button>
                <p id="login-error" class="text-red-500 text-sm text-center"></p>
            </div>
        </div>
    </div>

    <!-- Contingut Principal de l'App (Ocult per defecte) -->
    <div id="app-container" class="hidden container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
        <header class="mb-10">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Idees per a la Casa</h1>
                <div class="text-right">
                    <p id="user-email" class="text-sm text-gray-600"></p>
                    <button onclick="logout()" class="text-sm text-blue-600 hover:underline">Tancar sessió</button>
                </div>
            </div>
            <div class="mt-6 relative">
                 <input type="text" id="search-bar" placeholder="Cerca per text o etiqueta (ex: tag: cuina)" class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                 <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>
        </header>

        <div class="mb-8 bg-white p-4 rounded-xl shadow-md">
            <div class="flex flex-col sm:flex-row gap-4">
                <input type="text" id="new-room-name" placeholder="Nom de la nova habitació" class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="addRoom()" class="bg-blue-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2">
                    <i class="ph-bold ph-plus-circle text-xl"></i><span>Afegir Habitació</span>
                </button>
            </div>
        </div>

        <main id="rooms-container" class="space-y-8"></main>
        <div id="loading-message" class="text-center text-gray-500 mt-10">Carregant dades...</div>
    </div>

    <!-- Modal de Confirmació d'Esborrat -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 id="modal-title" class="text-lg font-bold text-gray-900">Confirmar acció</h3>
            <p id="modal-message" class="mt-2 text-sm text-gray-600">Estàs segur que vols continuar?</p>
            <div class="mt-6 flex justify-end gap-4">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel·lar</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Esborrar</button>
            </div>
        </div>
    </div>

    <script type="module">
        const firebaseConfig = {
          apiKey: "AIzaSyDjMJi26sdZIOt1c9b7JOl1i7XuFdT5kpw",
          authDomain: "canostra-cb0bc.firebaseapp.com",
          projectId: "canostra-cb0bc",
          storageBucket: "canostra-cb0bc.firebasestorage.app",
          messagingSenderId: "374627600235",
          appId: "1:374627600235:web:ec9d5da589a03d85a56e2e",
          measurementId: "G-PSDDZ36JNQ"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, updateDoc, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject, listAll } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const roomsContainer = document.getElementById('rooms-container');
        const loadingMessage = document.getElementById('loading-message');
        const searchBar = document.getElementById('search-bar');
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');

        let unsubscribeFromRooms = null; // Variable per guardar la funció de desconnexió

        // --- Gestió d'Autenticació ---
        onAuthStateChanged(auth, user => {
            if (user) {
                loginContainer.style.display = 'none';
                appContainer.style.display = 'block';
                document.getElementById('user-email').textContent = user.email;
                loadData();
            } else {
                loginContainer.style.display = 'flex';
                appContainer.style.display = 'none';
                // Si l'usuari tanca sessió, desconnectem el listener per netejar
                if (unsubscribeFromRooms) {
                    unsubscribeFromRooms();
                }
            }
        });

        window.login = () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorP = document.getElementById('login-error');
            errorP.textContent = '';
            signInWithEmailAndPassword(auth, email, password)
                .catch(error => {
                    errorP.textContent = 'Error: Correu o contrasenya incorrectes.';
                });
        };

        window.logout = () => signOut(auth);

        // --- Càrrega i Renderitzat de Dades ---
        function loadData() {
            // Si ja hi ha un listener actiu, el desconnectem primer
            if (unsubscribeFromRooms) {
                unsubscribeFromRooms();
            }

            // Creem el nou listener i guardem la seva funció de "desconnexió"
            unsubscribeFromRooms = onSnapshot(query(collection(db, "rooms"), orderBy("createdAt", "asc")), async (snapshot) => {
                const roomsData = [];
                const promises = snapshot.docs.map(async (roomDoc) => {
                    const room = { id: roomDoc.id, ...roomDoc.data(), ideas: [], images: [] };
                    const ideasQuery = query(collection(db, `rooms/${room.id}/ideas`), orderBy("createdAt", "asc"));
                    const imagesQuery = query(collection(db, `rooms/${room.id}/images`), orderBy("createdAt", "asc"));
                    
                    const [ideasSnapshot, imagesSnapshot] = await Promise.all([getDocs(ideasQuery), getDocs(imagesQuery)]);
                    room.ideas = ideasSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    room.images = imagesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    roomsData.push(room);
                });

                await Promise.all(promises);
                roomsData.sort((a, b) => a.createdAt.toMillis() - b.createdAt.toMillis());
                renderRooms(roomsData);
            });
        }


        function renderRooms(rooms) {
            roomsContainer.innerHTML = '';
            loadingMessage.style.display = rooms.length === 0 ? 'block' : 'none';
            if (rooms.length === 0) loadingMessage.textContent = 'No hi ha cap habitació. Afegeix-ne una per començar!';

            rooms.forEach(room => {
                const roomElement = document.createElement('section');
                roomElement.className = 'room-section bg-white rounded-xl shadow-lg p-6 sm:p-8';
                roomElement.dataset.roomTags = (room.tags || []).join(',');

                const necessitats = room.ideas.filter(i => i.section === 'necessitat');
                const referencies = room.ideas.filter(i => i.section === 'referencia');
                const opcionals = room.ideas.filter(i => i.section === 'opcional');

                roomElement.innerHTML = `
                    <div class="flex justify-between items-center border-b-2 border-gray-100 pb-3 mb-5">
                        <h2 class="text-2xl font-semibold text-gray-800">${room.name}</h2>
                        <button onclick="deleteRoom('${room.id}', '${room.name}')" class="text-gray-400 hover:text-red-500 transition p-2 rounded-full"><i class="ph-bold ph-trash text-2xl"></i></button>
                    </div>
                    
                    <div class="mt-4" id="tags-section-${room.id}">
                        ${renderRoomTags(room)}
                    </div>

                    ${renderSection(room, 'necessitat', 'Necessitat principal', necessitats)}
                    ${renderSection(room, 'referencia', 'Referències', referencies)}
                    ${renderSection(room, 'opcional', 'Opcionals', opcionals)}
                    ${renderImageSection(room)}
                `;
                roomsContainer.appendChild(roomElement);
            });
        }
        
        function renderRoomTags(room) {
            const tagsHTML = (room.tags || []).map(tag => `<span class="tag text-sm font-medium mr-2 mb-2 inline-block px-3 py-1 rounded-full">${tag}</span>`).join('');
            return `
                <div class="flex items-center gap-4">
                     <h3 class="text-xl font-medium text-gray-700">Etiquetes</h3>
                     <button onclick="editRoomTags('${room.id}')" class="text-gray-400 hover:text-blue-500 transition p-1 rounded-full"><i class="ph ph-pencil-simple"></i></button>
                </div>
                <div class="mt-2 flex flex-wrap">
                    ${tagsHTML || '<p class="text-sm text-gray-500">No hi ha etiquetes per a aquesta habitació.</p>'}
                </div>
            `;
        }

        function renderSection(room, sectionId, title, ideas) {
            return `<div class="mt-8 border-t border-gray-100 pt-6"><h3 class="text-xl font-medium text-gray-700 mb-3">${title}</h3><ul class="space-y-2 list-none pl-0">${ideas.map(idea => renderIdea(idea, room.id)).join('')}</ul><div class="mt-4"><input type="text" id="new-idea-text-${room.id}-${sectionId}" placeholder="Nova idea..." class="w-full p-2 border border-gray-300 rounded-lg"><button onclick="addIdea('${room.id}', '${sectionId}')" class="mt-2 bg-gray-200 text-gray-700 font-semibold px-4 py-2 rounded-lg hover:bg-gray-300 transition">Afegir</button></div></div>`;
        }

        function renderIdea(idea, roomId) {
            const isLink = idea.text.startsWith('http');
            const content = isLink ? `<a href="${idea.text}" target="_blank" class="text-blue-600 hover:underline break-all">${idea.text}</a>` : `<span class="break-words">${idea.text}</span>`;
            
            return `<li class="list-item"><div class="flex items-center justify-between group p-2 rounded-md hover:bg-gray-50"><div class="flex-grow" ondblclick="editIdea(this, '${roomId}', '${idea.id}')">${content}</div><div class="action-buttons flex items-center gap-2 ml-4"><button onclick="editIdea(this.parentElement.previousElementSibling, '${roomId}', '${idea.id}')" class="text-gray-400 hover:text-blue-500 p-1"><i class="ph ph-pencil-simple"></i></button><button onclick="deleteIdea('${roomId}', '${idea.id}')" class="text-gray-400 hover:text-red-500 p-1"><i class="ph ph-trash"></i></button></div></div></li>`;
        }

        function renderImageSection(room) {
            return `<div class="mt-8 border-t border-gray-100 pt-6"><h3 class="text-xl font-medium text-gray-700 mb-3">Imatges</h3><div class="grid grid-cols-2 sm:grid-cols-3 gap-4">${room.images.map(img => `<div class="image-item relative group"><img src="${img.url}" class="w-full h-32 object-cover rounded-lg shadow-md"><div class="action-buttons absolute top-1 right-1"><button onclick="deleteImage('${room.id}', '${img.id}', '${img.path}')" class="bg-black bg-opacity-50 text-white rounded-full p-1.5"><i class="ph-bold ph-trash"></i></button></div></div>`).join('')}</div><div class="mt-4"><label for="image-upload-${room.id}" class="cursor-pointer bg-green-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-green-600 transition inline-flex items-center gap-2"><i class="ph ph-upload-simple"></i>Pujar Imatge</label><input type="file" id="image-upload-${room.id}" class="hidden" accept="image/*" onchange="uploadImage(event, '${room.id}')"><p id="upload-progress-${room.id}" class="text-sm text-gray-500 mt-2"></p></div></div>`;
        }
        
        // --- Lògica de Dades (CRUD) ---
        
        function showConfirmationModal(title, message, onConfirm) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            const newConfirmBtn = modalConfirmBtn.cloneNode(true);
            modalConfirmBtn.parentNode.replaceChild(newConfirmBtn, modalConfirmBtn);
            newConfirmBtn.onclick = () => {
                onConfirm();
                confirmationModal.classList.add('hidden');
            };
            modalCancelBtn.onclick = () => confirmationModal.classList.add('hidden');
            confirmationModal.classList.remove('hidden');
        }

        window.addRoom = async () => {
            const input = document.getElementById('new-room-name');
            if (input.value.trim()) {
                await addDoc(collection(db, "rooms"), { 
                    name: input.value.trim(), 
                    tags: [],
                    createdAt: new Date() 
                });
                input.value = '';
            }
        };

        window.deleteRoom = (roomId, roomName) => {
            showConfirmationModal(
                `Esborrar "${roomName}"`,
                'Segur que vols esborrar aquesta habitació i TOTES les seves idees i imatges? Aquesta acció no es pot desfer.',
                async () => {
                    const roomImagesRef = ref(storage, `images/${roomId}`);
                    const res = await listAll(roomImagesRef);
                    await Promise.all(res.items.map(r => deleteObject(r)));
                    const subcollections = ['ideas', 'images'];
                    for (const sc of subcollections) {
                        const snapshot = await getDocs(query(collection(db, `rooms/${roomId}/${sc}`)));
                        await Promise.all(snapshot.docs.map(d => deleteDoc(d.ref)));
                    }
                    await deleteDoc(doc(db, "rooms", roomId));
                }
            );
        };

        window.addIdea = async (roomId, section) => {
            const textInput = document.getElementById(`new-idea-text-${roomId}-${section}`);
            const text = textInput.value.trim();
            if (text) {
                await addDoc(collection(db, `rooms/${roomId}/ideas`), { text, section, createdAt: new Date() });
                textInput.value = '';
            }
        };

        window.deleteIdea = (roomId, ideaId) => {
            showConfirmationModal(
                'Esborrar idea',
                'Segur que vols esborrar aquesta idea?',
                async () => {
                    await deleteDoc(doc(db, `rooms/${roomId}/ideas`, ideaId));
                }
            );
        };
        
        window.editIdea = async (element, roomId, ideaId) => {
            const ideaDocRef = doc(db, `rooms/${roomId}/ideas`, ideaId);
            const ideaSnapshot = await getDocs(query(collection(db, `rooms/${roomId}/ideas`))).then(s => s.docs.find(d => d.id === ideaId));
            if (!ideaSnapshot) return;
            const ideaData = ideaSnapshot.data();

            element.innerHTML = `<div class="p-2 border border-blue-500 rounded-lg"><input type="text" value="${ideaData.text}" class="w-full p-1 rounded-md mb-2"><div class="mt-2"><button class="save-btn bg-blue-500 text-white px-3 py-1 rounded-md text-sm">Desar</button> <button class="cancel-btn text-sm">Cancel·lar</button></div></div>`;
            const textInput = element.querySelector('input[type="text"]');
            element.querySelector('.save-btn').onclick = async () => {
                const newText = textInput.value.trim();
                if (newText) await updateDoc(ideaDocRef, { text: newText });
            };
            element.querySelector('.cancel-btn').onclick = () => loadData();
        };

        window.editRoomTags = async (roomId) => {
            const tagsSection = document.getElementById(`tags-section-${roomId}`);
            const roomDocRef = doc(db, "rooms", roomId);
            const roomSnapshot = await getDocs(query(collection(db, "rooms"))).then(s => s.docs.find(d => d.id === roomId));
            if (!roomSnapshot) return;
            const currentTags = roomSnapshot.data().tags || [];

            tagsSection.innerHTML = `
                <div class="p-2 border border-blue-500 rounded-lg">
                    <h3 class="text-xl font-medium text-gray-700 mb-2">Editar Etiquetes</h3>
                    <input type="text" value="${currentTags.join(', ')}" class="w-full p-2 border border-gray-300 rounded-lg">
                    <div class="mt-2">
                        <button class="save-tags-btn bg-blue-500 text-white px-3 py-1 rounded-md text-sm">Desar</button>
                        <button class="cancel-tags-btn text-sm ml-2">Cancel·lar</button>
                    </div>
                </div>
            `;

            tagsSection.querySelector('.save-tags-btn').onclick = async () => {
                const input = tagsSection.querySelector('input');
                const newTags = input.value.split(',').map(t => t.trim()).filter(Boolean);
                await updateDoc(roomDocRef, { tags: newTags });
            };
            tagsSection.querySelector('.cancel-tags-btn').onclick = () => loadData();
        };

        window.uploadImage = async (event, roomId) => {
            const file = event.target.files[0];
            if (!file) return;
            const progressText = document.getElementById(`upload-progress-${roomId}`);
            progressText.textContent = 'Pujant...';
            const storageRef = ref(storage, `images/${roomId}/${Date.now()}_${file.name}`);
            try {
                const snapshot = await uploadBytes(storageRef, file);
                const url = await getDownloadURL(snapshot.ref);
                await addDoc(collection(db, `rooms/${roomId}/images`), { url, path: snapshot.ref.fullPath, createdAt: new Date() });
            } catch (error) {
                console.error("Error:", error);
                progressText.textContent = 'Error en pujar.';
            } finally {
                progressText.textContent = '';
                event.target.value = '';
            }
        };

        window.deleteImage = (roomId, imageId, imagePath) => {
            showConfirmationModal('Esborrar imatge', 'Segur que vols esborrar aquesta imatge?',
                async () => {
                    await deleteObject(ref(storage, imagePath));
                    await deleteDoc(doc(db, `rooms/${roomId}/images`, imageId));
                }
            );
        };

        // --- Lògica de Cerca ---
        searchBar.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('.room-section').forEach(room => {
                const roomTags = room.dataset.roomTags.toLowerCase();
                const roomTextContent = room.textContent.toLowerCase();
                let isVisible = true;

                if (searchTerm.startsWith('tag:')) {
                    const searchTag = searchTerm.replace('tag:', '').trim();
                    if (searchTag && !roomTags.split(',').includes(searchTag)) {
                        isVisible = false;
                    }
                } else if (searchTerm && !roomTextContent.includes(searchTerm)) {
                    isVisible = false;
                }
                
                room.style.display = isVisible ? 'block' : 'none';
            });
        });
    </script>
</body>
</html>
